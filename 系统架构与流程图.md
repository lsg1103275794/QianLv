# 千虑 (QianLv) - 系统架构与流程图

本文档包含项目的系统架构图和主要业务流程图，帮助开发者快速理解系统设计。

---

## 目录

- [整体系统架构](#整体系统架构)
- [技术栈架构](#技术栈架构)
- [数据流架构](#数据流架构)
- [业务流程图](#业务流程图)
- [组件关系图](#组件关系图)
- [部署架构](#部署架构)

---

## 整体系统架构

### 三层架构图

```mermaid
graph TB
    subgraph "前端层 - Vue 3"
        A[用户界面]
        A --> B[文本分析]
        A --> C[文学分析]
        A --> D[风格迁移]
        A --> E[研报生成]
        A --> F[聊天测试]
        A --> G[API管理]
        A --> H[数据终端]
        
        B & C & D & E & F & G & H --> I[Vue Router]
        I --> J[API Service层]
        J --> K[Axios HTTP Client]
    end
    
    K -->|HTTP/HTTPS| L[API网关 - FastAPI]
    
    subgraph "后端层 - Python"
        L --> M[路由层]
        M --> N[业务逻辑层]
        
        subgraph "业务逻辑层"
            N --> O[文本分析服务]
            N --> P[文学分析服务]
            N --> Q[风格迁移服务]
            N --> R[研报生成服务]
            N --> S[热点追踪服务]
        end
        
        O & P & Q & R & S --> T[AI Provider工厂]
        
        subgraph "AI服务层"
            T --> U1[Ollama Local]
            T --> U2[Deepseek AI]
            T --> U3[Google Gemini]
            T --> U4[OpenRouter]
            T --> U5[其他10+服务商]
        end
    end
    
    subgraph "数据层"
        N --> V[SQLite数据库]
        N --> W[文件系统]
        N --> X[缓存系统]
        
        V --> V1[分析结果]
        V --> V2[聊天历史]
        V --> V3[任务队列]
        
        W --> W1[上传文件]
        W --> W2[导出文件]
        
        X --> X1[分析缓存]
        X --> X2[风格缓存]
    end
    
    U1 & U2 & U3 & U4 & U5 -->|LLM响应| N

    style A fill:#4CAF50
    style L fill:#2196F3
    style N fill:#FF9800
    style V fill:#9C27B0
```

---

## 技术栈架构

### 前端技术栈

```mermaid
graph LR
    subgraph "核心框架"
        A[Vue 3.4]
        B[Vue Router 4]
        C[Vue I18n 9]
    end
    
    subgraph "UI组件"
        D[Element Plus 2.5]
        E[ECharts 5]
        F[Vue-ECharts 6]
    end
    
    subgraph "数据处理"
        G[Axios]
        H[Lodash]
        I[Jieba-JS]
    end
    
    subgraph "文档处理"
        J[Marked]
        K[Highlight.js]
        L[jsPDF]
        M[docx]
    end
    
    subgraph "动画交互"
        N[GSAP]
        O[Chart.js]
    end
    
    A --> D
    B --> A
    C --> A
    D --> E
    G --> A
    H --> G
    J --> A
    N --> A

    style A fill:#42b883
    style D fill:#409eff
    style E fill:#5470c6
```

### 后端技术栈

```mermaid
graph LR
    subgraph "Web框架"
        A[FastAPI 0.110]
        B[Uvicorn]
        C[Starlette]
    end
    
    subgraph "数据处理"
        D[SQLAlchemy 2.0]
        E[Pandas]
        F[NumPy]
    end
    
    subgraph "AI/NLP"
        G[Transformers]
        H[Sentence-Transformers]
        I[NLTK]
        J[Jieba]
        K[TextBlob]
    end
    
    subgraph "文件处理"
        L[PyMuPDF]
        M[python-docx]
        N[EbookLib]
        O[pdfplumber]
    end
    
    subgraph "API集成"
        P[httpx]
        Q[aiohttp]
        R[requests]
    end
    
    subgraph "工具库"
        S[Loguru]
        T[PyYAML]
        U[jsonschema]
    end
    
    A --> B
    A --> C
    A --> D
    D --> E
    E --> F
    G --> H
    H --> I

    style A fill:#009688
    style G fill:#ff6b6b
    style P fill:#4ecdc4
```

---

## 数据流架构

### 请求处理流程

```mermaid
sequenceDiagram
    participant U as 用户浏览器
    participant F as Vue前端
    participant A as API网关
    participant S as 业务服务
    participant P as AI Provider
    participant D as 数据库
    participant C as 缓存

    U->>F: 1. 发起请求
    F->>F: 2. 表单验证
    F->>A: 3. HTTP请求 (JSON)
    A->>A: 4. 路由匹配
    A->>A: 5. 请求验证
    
    alt 缓存存在
        A->>C: 6a. 检查缓存
        C-->>A: 返回缓存数据
        A-->>F: 立即返回结果
    else 缓存不存在
        A->>S: 6b. 调用业务服务
        S->>S: 7. 数据处理
        S->>P: 8. 调用AI服务
        P-->>S: 9. AI响应
        S->>S: 10. 结果处理
        S->>D: 11. 保存结果
        S->>C: 12. 写入缓存
        S-->>A: 13. 返回响应
        A-->>F: 14. 返回JSON
    end
    
    F->>F: 15. 数据渲染
    F->>U: 16. 显示结果
```

### 配置更新流程

```mermaid
sequenceDiagram
    participant U as 用户
    participant UI as 前端界面
    participant API as API服务
    participant ENV as .env文件
    participant PF as Provider工厂
    participant H as Handler

    U->>UI: 1. 修改配置
    UI->>UI: 2. 表单验证
    UI->>API: 3. PUT /api/providers/{name}
    API->>API: 4. 验证配置
    API->>ENV: 5. 更新.env文件
    ENV-->>API: 6. 写入成功
    API->>PF: 7. 通知配置更新
    PF->>PF: 8. 清除旧配置缓存
    API-->>UI: 9. 返回成功
    UI->>U: 10. 显示更新成功
    
    Note over U,H: 下次API调用时
    U->>UI: 11. 发起新请求
    UI->>API: 12. 调用API
    API->>PF: 13. 获取Handler
    PF->>H: 14. 创建/获取Handler
    H->>ENV: 15. 读取最新配置
    ENV-->>H: 16. 返回最新参数
    H->>H: 17. 使用新配置
```

---


## 业务流程图

### 1. 文本分析完整流程

```mermaid
flowchart TD
    Start([用户开始]) --> Upload{上传方式}
    
    Upload -->|文件上传| FileUpload[选择文件]
    Upload -->|直接输入| TextInput[粘贴文本]
    
    FileUpload --> Validate[文件验证]
    Validate --> ValidCheck{验证通过?}
    ValidCheck -->|否| Error1[显示错误]
    ValidCheck -->|是| Extract[提取文本]
    
    TextInput --> Extract
    Extract --> SelectDim[选择分析维度]
    
    SelectDim --> DimOptions[勾选分析项]
    DimOptions --> Sentiment[情感分析]
    DimOptions --> Keywords[关键词提取]
    DimOptions --> Readability[可读性分析]
    
    Sentiment & Keywords & Readability --> SelectProvider[选择AI服务商]
    SelectProvider --> CallLLM[调用LLM分析]
    CallLLM --> Display[前端显示]
    Display --> Charts[生成可视化图表]
    Charts --> Export{用户操作}
    Export -->|导出| Download[下载文件]
    Download --> End([结束])
    
    style Start fill:#4CAF50
    style End fill:#f44336
    style CallLLM fill:#2196F3
```

### 2. 智能研报生成流程

```mermaid
flowchart TD
    Start([用户开始]) --> InputTopic[输入研报主题]
    InputTopic --> SelectMode{选择生成模式}
    
    SelectMode -->|本地| OllamaMode[Ollama本地模式]
    SelectMode -->|云端| CloudMode[云端API模式]
    SelectMode -->|热点| HotTopicMode[热点话题模式]
    
    OllamaMode & CloudMode & HotTopicMode --> LLMPlan[LLM规划搜索策略]
    LLMPlan --> GenQueries[生成搜索查询]
    GenQueries --> WebSearch[执行Web搜索]
    WebSearch --> CollectResults[收集搜索结果]
    CollectResults --> LLMAnalyze[LLM分析整合]
    LLMAnalyze --> BuildReport[构建研报结构]
    
    BuildReport --> Section1[执行摘要]
    BuildReport --> Section2[详细分析]
    BuildReport --> Section3[趋势预测]
    
    Section1 & Section2 & Section3 --> FormatMD[格式化Markdown]
    FormatMD --> DisplayReport[显示研报]
    DisplayReport --> Actions{用户操作}
    Actions -->|导出| ExportReport[导出研报]
    ExportReport --> End([完成])
    
    style Start fill:#4CAF50
    style LLMPlan fill:#2196F3
    style LLMAnalyze fill:#00BCD4
```

### 3. 文学多维分析与风格迁移流程

```mermaid
flowchart TD
    Start([开始分析]) --> LoadTemplate[加载V2分析模板]
    LoadTemplate --> DisplayDimensions[展示可选维度]
    
    DisplayDimensions --> Cat1[人物塑造]
    DisplayDimensions --> Cat2[情节构建]
    DisplayDimensions --> Cat3[主题探讨]
    DisplayDimensions --> Cat4[语言风格]
    
    Cat1 & Cat2 & Cat3 & Cat4 --> UserSelect[用户选择维度]
    UserSelect --> UploadText[上传文学文本]
    UploadText --> BuildPrompt[构建分析提示词]
    BuildPrompt --> CallLLM[调用LLM]
    CallLLM --> LLMAnalysis[LLM深度分析]
    LLMAnalysis --> DisplayResult[展示完整报告]
    
    DisplayResult --> ConnectStyle{是否进行风格迁移?}
    ConnectStyle -->|是| SampleExtraction[提取文学分析样本]
    SampleExtraction --> StyleModule[进入风格迁移模块]
    StyleModule --> ArticleRewrite[基于样本进行文章改写]
    ArticleRewrite --> UseCase[应用场景: 文案改写/洗稿]
    UseCase --> End([完成])
    
    ConnectStyle -->|否| End
    
    style Start fill:#4CAF50
    style BuildPrompt fill:#2196F3
    style LLMAnalysis fill:#FF9800
    style StyleModule fill:#E91E63
    style ArticleRewrite fill:#9C27B0
```

### 4. AI服务商配置流程

```mermaid
flowchart TD
    Start([进入API管理]) --> LoadProviders[加载服务商列表]
    LoadProviders --> DisplayCards[显示服务商卡片]
    DisplayCards --> UserClick{用户操作}
    
    UserClick -->|查看详情| OpenDrawer[打开配置抽屉]
    UserClick -->|测试连接| TestConnection[测试API连接]
    
    OpenDrawer --> EditMode[编辑配置]
    EditMode --> ModifyFields[修改字段值]
    ModifyFields --> SaveConfig[保存配置]
    SaveConfig --> UpdateEnv[更新.env文件]
    UpdateEnv --> ShowSuccess[显示成功消息]
    
    TestConnection --> TestLLM[测试LLM调用]
    TestLLM --> ShowResult[显示测试结果]
    
    ShowSuccess & ShowResult --> End([完成])
    
    style Start fill:#4CAF50
    style SaveConfig fill:#2196F3
    style TestLLM fill:#FF9800
```

---

## 组件关系图

### 前端组件依赖关系

```mermaid
graph TB
    subgraph "根组件"
        App[App.vue]
    end
    
    subgraph "路由管理"
        Router[Vue Router]
    end
    
    subgraph "页面视图 Views"
        V1[TextAnalysis]
        V2[WritingStyleAnalysis]
        V3[StyleTransfer]
        V4[ReportGeneratorView]
        V5[ModelTestView]
        V6[DataTerminal]
        V7[ApiManager]
    end
    
    subgraph "分析组件 Components/Analysis"
        C1[AnalysisResults]
        C2[SentimentChart]
        C3[KeywordChart]
        C4[ReadabilityChart]
    end
    
    subgraph "API组件 Components/API"
        A1[ApiProviderCard]
        A2[ApiConfigDrawer]
        A3[ApiStatusCheck]
    end
    
    subgraph "聊天组件 Components/Chat"
        CH1[ChatTest]
        CH2[ChatMessages]
        CH3[ChatInput]
    end
    
    subgraph "研报组件 Components/Report"
        R1[ReportForm]
        R2[ReportDisplay]
        R3[ReportLoading]
    end
    
    subgraph "服务层 Services"
        S1[analysisService]
        S2[chatService]
        S3[reportService]
        S4[providerService]
        S5[apiClient]
    end
    
    App --> Router
    Router --> V1 & V2 & V3 & V4 & V5 & V6 & V7
    
    V1 --> C1 & C2 & C3 & C4
    V1 --> S1
    
    V2 --> C1
    V2 --> S1
    
    V4 --> R1 & R2 & R3
    V4 --> S3
    
    V5 --> CH1
    CH1 --> CH2 & CH3
    V5 --> S2
    
    V7 --> A1 & A2 & A3
    V7 --> S4
    
    S1 & S2 & S3 & S4 --> S5
    
    style App fill:#42b883
    style Router fill:#35495e
    style S5 fill:#ff6b6b
```

### 后端模块依赖关系

```mermaid
graph TB
    subgraph "入口层"
        Main[backend_main.py]
    end
    
    subgraph "路由层 API Routes"
        R1[analysis.py]
        R2[literature_analysis.py]
        R3[chat.py]
        R4[report_generator_api.py]
        R5[providers.py]
        R6[files.py]
    end
    
    subgraph "服务层 Services"
        S1[ReportGeneratorService]
        S2[HotTopicsService]
    end
    
    subgraph "核心层 Core"
        C1[literature_analyzer.py]
        C2[style_transfer.py]
        C3[basic_analyzer.py]
    end
    
    subgraph "提供商层 Providers"
        P0[factory.py]
        P1[BaseAPIHandler]
        P2[OllamaLocalHandler]
        P3[DeepseekAIHandler]
        P4[GoogleGeminiHandler]
        P5[其他Handler]
    end
    
    subgraph "工具层 Utils"
        U1[logging.py]
        U2[config.py]
        U3[cache.py]
        U4[error_handler.py]
    end
    
    subgraph "数据层"
        D1[SQLite数据库]
        D2[文件系统]
        D3[缓存系统]
    end
    
    Main --> R1 & R2 & R3 & R4 & R5 & R6
    
    R1 --> C3
    R2 --> C1
    R3 --> P0
    R4 --> S1
    R5 --> P0
    
    S1 --> P0
    S2 --> P0
    
    C1 & C2 & C3 --> P0
    
    P0 --> P1
    P1 --> P2 & P3 & P4 & P5
    
    R1 & R2 & R3 & R4 --> U1 & U2 & U3 & U4
    S1 & S2 --> U1 & U2
    P0 --> U2
    
    R1 & R2 & R3 & R4 --> D1
    R6 --> D2
    C1 & C2 & C3 --> D3
    
    style Main fill:#009688
    style P0 fill:#ff6b6b
    style D1 fill:#9C27B0
```

---

## 部署架构

### 开发环境架构

```mermaid
graph TB
    subgraph "开发机器"
        subgraph "前端开发服务器"
            FE[Vue Dev Server<br/>localhost:8080]
            FE_HMR[热模块替换 HMR]
        end
        
        subgraph "后端开发服务器"
            BE[FastAPI + Uvicorn<br/>localhost:8000<br/>--reload模式]
            BE_API[API文档<br/>/docs]
        end
        
        subgraph "本地AI服务"
            Ollama[Ollama<br/>localhost:11434]
            Models[本地模型<br/>gemma3:12b]
        end
        
        subgraph "本地存储"
            DB[(SQLite数据库<br/>data/QianLv_data.db)]
            Files[文件系统<br/>data/uploads]
            Cache[缓存<br/>.cache/]
        end
    end
    
    subgraph "外部服务"
        Cloud1[Deepseek AI]
        Cloud2[Google Gemini]
        Cloud3[其他云端服务]
        Serper[Serper搜索API]
    end
    
    FE -->|HTTP请求| BE
    BE -->|调用| Ollama
    BE -->|API调用| Cloud1 & Cloud2 & Cloud3
    BE -->|搜索请求| Serper
    BE -->|读写| DB & Files & Cache
    Ollama --> Models
    
    style FE fill:#42b883
    style BE fill:#009688
    style Ollama fill:#646cff
    style DB fill:#9C27B0
```

### 生产环境架构

```mermaid
graph TB
    subgraph "负载均衡层"
        LB[Nginx<br/>负载均衡器<br/>443端口]
        SSL[SSL证书<br/>HTTPS]
    end
    
    subgraph "应用服务器集群"
        App1[FastAPI实例1<br/>Gunicorn + Uvicorn]
        App2[FastAPI实例2<br/>Gunicorn + Uvicorn]
        App3[FastAPI实例N<br/>Gunicorn + Uvicorn]
    end
    
    subgraph "静态资源"
        Static[前端静态文件<br/>frontend/dist/]
    end
    
    subgraph "数据库层"
        DB[(PostgreSQL<br/>主数据库)]
        DBR[(PostgreSQL<br/>只读副本)]
    end
    
    subgraph "缓存层"
        Redis[Redis缓存<br/>会话 + 分析结果]
    end
    
    subgraph "文件存储"
        S3[对象存储<br/>S3/OSS<br/>上传文件]
    end
    
    subgraph "监控告警"
        Monitor[Prometheus<br/>Grafana]
        Log[ELK Stack<br/>日志聚合]
        Alert[告警系统]
    end
    
    subgraph "AI服务"
        AIPool[AI服务池<br/>多提供商<br/>自动切换]
    end
    
    Users[用户] -->|HTTPS| LB
    SSL --> LB
    LB --> Static
    LB --> App1 & App2 & App3
    
    App1 & App2 & App3 --> DB
    App1 & App2 & App3 --> Redis
    App1 & App2 & App3 --> S3
    App1 & App2 & App3 --> AIPool
    
    DB --> DBR
    
    App1 & App2 & App3 --> Monitor
    App1 & App2 & App3 --> Log
    Monitor --> Alert
    
    style LB fill:#00bcd4
    style DB fill:#9C27B0
    style Redis fill:#f44336
    style AIPool fill:#ff9800
```

### Docker容器化部署

```mermaid
graph TB
    subgraph "Docker Host"
        subgraph "应用容器"
            App[QianLv-app<br/>Python 3.12<br/>FastAPI + Frontend]
        end
        
        subgraph "数据库容器"
            DB[postgres:15<br/>PostgreSQL]
        end
        
        subgraph "缓存容器"
            Cache[redis:7<br/>Redis]
        end
        
        subgraph "反向代理"
            Nginx[nginx:alpine<br/>反向代理]
        end
        
        subgraph "AI服务容器"
            OllamaC[ollama/ollama<br/>本地AI服务]
        end
    end
    
    subgraph "Docker Volumes"
        Vol1[db_data<br/>数据库持久化]
        Vol2[app_data<br/>应用数据]
        Vol3[redis_data<br/>缓存数据]
    end
    
    subgraph "Docker Networks"
        Net[QianLv_network<br/>内部网络]
    end
    
    Users[用户] -->|80/443| Nginx
    Nginx -->|8000| App
    App --> DB
    App --> Cache
    App --> OllamaC
    
    DB --> Vol1
    App --> Vol2
    Cache --> Vol3
    
    App & DB & Cache & Nginx & OllamaC -.-> Net
    
    style Nginx fill:#00bcd4
    style App fill:#009688
    style DB fill:#9C27B0
    style OllamaC fill:#646cff
```

---

## 数据流详解

### 1. 请求-响应数据流

```mermaid
sequenceDiagram
    participant User as 用户
    participant Browser as 浏览器
    participant Vue as Vue前端
    participant Axios as Axios
    participant FastAPI as FastAPI
    participant Service as 业务服务
    participant Provider as AI Provider
    participant DB as 数据库
    participant Cache as 缓存

    User->>Browser: 1. 触发操作
    Browser->>Vue: 2. 组件事件
    Vue->>Vue: 3. 数据验证
    Vue->>Axios: 4. 发起HTTP请求
    Axios->>FastAPI: 5. POST /api/xxx
    
    FastAPI->>FastAPI: 6. 路由匹配
    FastAPI->>FastAPI: 7. 参数验证
    
    FastAPI->>Cache: 8. 检查缓存
    
    alt 缓存命中
        Cache-->>FastAPI: 9a. 返回缓存数据
        FastAPI-->>Axios: 10a. 立即响应
    else 缓存未命中
        FastAPI->>Service: 9b. 调用服务
        Service->>Provider: 10b. 调用AI
        Provider-->>Service: 11b. AI响应
        Service->>DB: 12b. 保存结果
        Service->>Cache: 13b. 写入缓存
        Service-->>FastAPI: 14b. 返回结果
        FastAPI-->>Axios: 15b. 响应JSON
    end
    
    Axios-->>Vue: 16. 返回数据
    Vue->>Vue: 17. 更新状态
    Vue->>Browser: 18. 渲染UI
    Browser->>User: 19. 显示结果
```

### 2. 流式响应数据流（SSE）

```mermaid
sequenceDiagram
    participant User as 用户
    participant Vue as Vue前端
    participant SSE as EventSource
    participant FastAPI as FastAPI
    participant LLM as LLM服务

    User->>Vue: 1. 发起聊天请求
    Vue->>SSE: 2. 建立SSE连接
    SSE->>FastAPI: 3. GET /api/chat/stream
    
    FastAPI->>LLM: 4. 调用LLM流式API
    
    loop 流式生成
        LLM-->>FastAPI: 5. 生成token片段
        FastAPI-->>SSE: 6. 发送SSE事件
        SSE-->>Vue: 7. 触发onmessage
        Vue->>Vue: 8. 追加内容
        Vue->>User: 9. 实时显示
    end
    
    LLM-->>FastAPI: 10. 生成完成
    FastAPI-->>SSE: 11. 发送完成事件
    SSE->>SSE: 12. 关闭连接
    Vue->>User: 13. 显示完整回复
```

### 3. 配置实时更新数据流

```mermaid
sequenceDiagram
    participant User as 用户
    participant UI as 配置界面
    participant API as API服务
    participant ENV as .env文件
    participant Factory as Provider工厂
    participant Handler as Handler实例

    User->>UI: 1. 修改配置
    UI->>API: 2. PUT /api/providers/{name}
    API->>API: 3. 验证配置
    API->>ENV: 4. 写入.env
    ENV-->>API: 5. 写入成功
    API->>Factory: 6. 清除缓存
    API-->>UI: 7. 返回成功
    UI->>User: 8. 显示更新成功
    
    Note over User,Handler: 下次API调用
    User->>UI: 9. 发起新请求
    UI->>API: 10. POST /api/analyze
    API->>Factory: 11. 获取Handler
    Factory->>Handler: 12. 创建/获取实例
    Handler->>ENV: 13. 读取最新配置
    ENV-->>Handler: 14. 返回新参数
    Handler->>Handler: 15. 使用新配置调用AI
```

---

## 性能优化架构

### 缓存策略

```mermaid
graph TB
    subgraph "请求处理"
        Request[API请求]
    end
    
    subgraph "三级缓存"
        L1[L1: 内存缓存<br/>LRU Cache<br/>热点数据]
        L2[L2: Redis缓存<br/>分析结果<br/>会话数据]
        L3[L3: 文件缓存<br/>.cache/目录<br/>长期存储]
    end
    
    subgraph "数据源"
        AI[AI服务]
        DB[(数据库)]
    end
    
    Request --> L1
    L1 -->|未命中| L2
    L2 -->|未命中| L3
    L3 -->|未命中| AI
    L3 -->|未命中| DB
    
    AI --> L3
    DB --> L3
    L3 --> L2
    L2 --> L1
    L1 --> Response[返回响应]
    
    style L1 fill:#4CAF50
    style L2 fill:#2196F3
    style L3 fill:#FF9800
```

### 异步处理架构

```mermaid
graph TB
    subgraph "同步请求"
        Sync[快速查询<br/>缓存读取<br/>简单分析]
    end
    
    subgraph "异步任务队列"
```
